stage ('mac_%VERSION%') {
  agent{
    label "%CITA_VERSION%&&mac&&%VERSION%"
  }
  steps {                
    script {
      echo "NODE_NAME = ${env.NODE_NAME}"            
      def testPath=""
      def citaDEVT=""
      def path = "/Dyalog/Dyalog-%VERSION%.app/Contents/Resources/Dyalog/mapl"
      def exists = fileExists(path)      
      if (exists) {
        echo "PLATFORM=mac, path=${path}: File exists!"
      } else {
        echo "PLATFORM=mac, path=${path}: File does not exist, trying another path"
        path = "/Applications/Dyalog-%VERSION%.app/Contents/Resources/Dyalog/mapl"
        exists = fileExists(path)          
        if (exists) {
          echo "PLATFORM=mac, path=${path}: File exists!"
        } else {
          error "PLATFORM=mac, path=${path}: File does not exist, giving it up!"
        }
      }
      testPath="%xinO%mac_%VERSION%_u64/"
      if ("${env.NODE_NAME}"=="mac3") {
        cmdline = cmdline.replace("/devt/","/Volumes/devt/")
        citaDEVT="/Volumes/devt/"
      } else {
        citaDEVT="/devt/"
      }
      def cmdline = "%CMDLINE% citaDEVT=${citaDEVT} USERCONFIGFILE=${testPath}cita.dcfg CITA_Log=${testPath}CITA.log LogFile=${testPath}CITA_Session.dlf"
      cmdline = "${cmdline} citaDEVT=${citaDEVT}"
      echo "Launching $path $cmdline"
      rcj = sh(script: "$path $cmdline" , returnStatus: true);
      exists = fileExists("${testPath}CITA.log.ok") 
      if (exists) {
        echo "Test succeeded"
        sh "exit 0"
      } else {
        echo "Test did not end with status file ${testPath}CITA.log.ok"
        sh "exit 1"
      }
    }
  }
}