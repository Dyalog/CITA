stage ('mac_%VERSION%') {
  agent{
    label "%CITA_VERSION%&&mac&&%VERSION%"
  }

  steps {                
    script {
      echo "NODE_NAME = ${env.NODE_NAME}"            
      def path = "/Dyalog/Dyalog-%VERSION%.app/Contents/Resources/Dyalog/mapl"
      def exists = fileExists(path)      
      def rcj=0    
      def citaDEVT="startValue"
      if (exists) {
        echo "PLATFORM=mac, path=${path}: File exists!"
      } else {
        echo "PLATFORM=mac, path=${path}: File does not exist, trying another path"
        path = "/Applications/Dyalog-%VERSION%.app/Contents/Resources/Dyalog/mapl"
        exists = fileExists(path)          
        if (exists) {
          echo "PLATFORM=mac, path=${path}: File exists!"
        } else {
          error "PLATFORM=mac, path=${path}: File does not exist, giving it up!"
        }
      }
      def cmdline = '%CMDLINE%'
      if ("${env.NODE_NAME}"=="mac3") {
        cmdline = cmdline.replace("/devt/","/Volumes/devt/")
        citaDEVT="/Volumes/devt/"
      } else {
        citaDEVT="/devt/"
      }
      cmdline = "${cmdline} citaDEVT=${citaDEVT}"
      echo "Launching $path $cmdline"
      rcj = sh(script: "$path $cmdline" , returnStatus: true);
      echo "Ended with returncode=$rcj"
      exists = fileExists("%CITA_LOG%.ok") 
      if (exists) {
        echo "Test succeeded"
        sh "exit 0"
      } else {
        echo "Test did not end with status file %CITA_LOG%.ok"
        sh "exit 1"
      }
    }
  }
}